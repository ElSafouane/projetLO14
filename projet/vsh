#! /bin/bash

#vsh

#Script coté client, il engagera la connexion avec le serveur


#On déclare les variables globales générales à toutes les commandes
declare -r mode=$1
declare -r NOM_SERV=$2
declare -r PORT=$3
declare -r ARCHIVE=$4


if [[ -z $NOM_SERV || -z $PORT ]];then
	echo "Veuillez rentrer un nom de serveur et un port"

else
	if [ "$mode" = "-create" ];then
		ls -Rl > listeFich #Le fichier listeFich est le fichier sur lequel on boucle pour afficher l'archive
			echo "Directory: $(pwd)" >> temp_header # on initialise la première ligne de notre header avant la boucle
			i=0
			j=0
			nomDirectory=()
			while read ligne 
			do

				set -- $ligne

				if [ "$9" != "$ARCHIVE" -a "$9" != "" ]; then #On vérifie si la ligne correspond bien à une ligne à afficher (ligne d'un fichier ou d'un répertoire)
						if [ -d $9 ]; then #Si c'est un répertoire
							((i++))
							nomDirectory[$i]="$9" #On enregistre le nom du répertoire afin d'afficher par la suite son arborescence		

						elif [ -r $9 ]; then #si le fichier est lisible on le met dans le fichier temporaire du body
							cat $9 >> temp_body
							taille=$(wc -l $9 | cut -f1 -d' ')
						fi	
							echo "$9 $1 $5 taille=$taille" >> temp_header
					
				fi
				if [[ "$ligne" = "" ]]; then #si la ligne de ls -Rl est vide cela signifie qu'on passe au répertoire suivant
					((j++))
					echo "@" >> temp_header
					echo "Directory: $(pwd)/${nomDirectory[$j]}" >> temp_header #donc on affiche le nom du répertoire et son fullpath
				fi

			done < "listeFich"		

			rm listeFich	
		echo ${mode:1} $ARCHIVE $(cat temp_header) | nc -w1 $NOM_SERV $PORT

	elif [ "$mode" = "-list" ];then
		echo ${mode:1} | nc -w1 $NOM_SERV $PORT
	fi
	
fi

